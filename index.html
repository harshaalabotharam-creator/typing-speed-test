<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Speed Test | Ghost Edition</title>
    <meta name="description" content="Test and improve your typing speed with real-time analytics and ghost cursor challenge.">
    <!-- Defer loading external resources -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <!-- Inline critical CSS for faster load -->
    <style>
        :root {
            --bg: #030712;
            --surface: rgba(17, 24, 39, 0.7);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.3);
            --ghost: rgba(255, 255, 255, 0.2);
            --text: #f3f4f6;
            --text-mute: #6b7280;
            --success: #10b981;
            --error: #ef4444;
        }

        .light {
            --bg: #f9fafb;
            --surface: rgba(255, 255, 255, 0.8);
            --border: rgba(0, 0, 0, 0.05);
            --accent: #6366f1;
            --text: #111827;
            --text-mute: #9ca3af;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
            padding: 20px;
        }

        /* Abstract Glows - Reduced blur for performance */
        .glow-1, .glow-2 {
            position: fixed;
            width: 50vw;
            height: 50vw;
            filter: blur(80px);
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }
        .glow-1 { top: -10%; left: -10%; background: var(--accent); }
        .glow-2 { bottom: -10%; right: -10%; background: #3b82f6; }

        .app-container {
            width: 100%;
            max-width: 1100px;
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 60px -20px rgba(0,0,0,0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
                border-radius: 20px;
            }
            .dash {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            .actions {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            .btn-group {
                width: 100%;
                justify-content: space-between;
            }
            #typing-box {
                font-size: 1.2rem;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .dash {
                grid-template-columns: 1fr;
            }
            .metric-value { font-size: 1.5rem; }
            #typing-box {
                font-size: 1rem;
                min-height: 120px;
            }
        }

        .dash {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        .metric-card:hover { 
            transform: translateY(-5px); 
            background: rgba(255,255,255,0.05); 
        }
        .metric-value { 
            display: block; 
            font-size: 2rem; 
            font-weight: 800; 
            color: var(--accent); 
            font-family: 'JetBrains Mono', monospace; 
        }
        .metric-label { 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: var(--text-mute); 
            margin-top: 5px;
        }

        #typing-box {
            position: relative;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            line-height: 1.6;
            padding: 25px;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            margin-bottom: 25px;
            min-height: 140px;
            cursor: text;
            overflow: hidden;
        }

        .char { 
            color: var(--text-mute); 
            position: relative; 
            transition: color 0.1s ease; 
        }
        .char.correct { color: var(--text); }
        .char.incorrect { 
            color: var(--error); 
            background: rgba(239, 68, 68, 0.1); 
            border-radius: 2px; 
        }

        .caret {
            position: absolute;
            width: 2px;
            height: 1.4rem;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            transition: left 0.1s ease, top 0.1s ease;
            z-index: 2;
        }
        .ghost-caret {
            position: absolute;
            width: 2px;
            height: 1.4rem;
            background: var(--ghost);
            border: 1px dashed rgba(255,255,255,0.3);
            transition: left 0.5s linear, top 0.5s linear;
            z-index: 1;
            opacity: 0;
        }

        .actions { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            flex-wrap: wrap;
            gap: 15px;
        }
        .btn-group { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 0.9rem;
        }
        button:hover { 
            opacity: 0.9; 
            transform: scale(1.03); 
        }
        button.secondary { 
            background: rgba(255,255,255,0.05); 
            color: var(--text); 
            border: 1px solid var(--border);
        }

        select {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 10px;
            outline: none;
            font-family: inherit;
            cursor: pointer;
        }

        #hidden-input { 
            position: absolute; 
            opacity: 0; 
            pointer-events: none; 
        }

        .chart-container { 
            height: 200px; 
            width: 100%; 
            margin-top: 20px; 
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), #a78bfa);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>

<div class="glow-1"></div>
<div class="glow-2"></div>

<div class="app-container">
    <div class="actions">
        <h2 style="font-weight: 800; letter-spacing: -0.5px; font-size: clamp(1.5rem, 4vw, 2rem);">
            TYPING<span style="color:var(--accent)">SPEED TEST</span>
        </h2>
        <div class="btn-group">
            <select id="timeSelect" aria-label="Select test duration">
                <option value="15">15s</option>
                <option value="30">30s</option>
                <option value="60" selected>60s</option>
            </select>
            <button class="secondary" id="themeBtn" aria-label="Toggle theme">ðŸŒ“</button>
            <button id="restartBtn" aria-label="Reset test">Reset</button>
        </div>
    </div>

    <div class="dash">
        <div class="metric-card">
            <span class="metric-label">Time Remaining</span>
            <span class="metric-value" id="timer">60</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">WPM (Net)</span>
            <span class="metric-value" id="wpm">0</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Accuracy</span>
            <span class="metric-value" id="accuracy">100%</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Best WPM</span>
            <span class="metric-value" id="bestWpm">0</span>
        </div>
    </div>

    <div class="progress-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progress-bar"></div>
    </div>

    <div id="typing-box" onclick="focusInput()" role="textbox" aria-label="Typing area">
        <div id="ghost-caret" class="ghost-caret" aria-hidden="true"></div>
        <div id="caret" class="caret" aria-hidden="true"></div>
        <div id="text-render"></div>
    </div>

    <input type="text" id="hidden-input" autocomplete="off" aria-hidden="true" tabindex="-1">

    <div class="chart-container">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
    // DOM Elements - cached for performance
    const textRender = document.getElementById('text-render');
    const hiddenInput = document.getElementById('hidden-input');
    const caret = document.getElementById('caret');
    const ghostCaret = document.getElementById('ghost-caret');
    const timerEl = document.getElementById('timer');
    const wpmEl = document.getElementById('wpm');
    const accuracyEl = document.getElementById('accuracy');
    const progressEl = document.getElementById('progress-bar');
    const bestWpmEl = document.getElementById('bestWpm');

    // Game state
    const sentenceBank = [
        "Consistency is the key to improving your typing speed and accuracy.",
        "Frontend developers transform complex ideas into interactive user experiences.",
        "Clean code and good design go hand in hand for modern web applications.",
        "Practice typing daily to build muscle memory and increase productivity.",
        "Smooth animations and fluid transitions make user experience more delightful.",
        "The quick brown fox jumps over the lazy dog in a silent forest.",
        "Programming is the art of telling a computer what to do precisely.",
        "Stay focused and maintain a steady rhythm to achieve high performance.",
        "JavaScript powers the interactive web with dynamic behavior and effects.",
        "Mastering keyboard shortcuts can significantly boost your workflow efficiency."
    ];
    
    let timer, timeLeft, maxTime;
    let charIndex = 0;
    let totalMistakes = 0;
    let totalCharsTyped = 0;
    let isStarted = false;
    let bestWpm = parseInt(localStorage.getItem('pro_best')) || 0;
    
    // Chart data
    let liveDataPoints = [];
    let liveLabels = [];
    let chart = null;

    // Initialize the application
    function init() {
        clearInterval(timer);
        maxTime = parseInt(document.getElementById('timeSelect').value);
        timeLeft = maxTime;
        charIndex = 0;
        totalMistakes = 0;
        totalCharsTyped = 0;
        isStarted = false;
        
        // Reset data
        liveDataPoints = [0];
        liveLabels = ["0s"];
        
        // Update UI
        timerEl.textContent = timeLeft;
        wpmEl.textContent = '0';
        accuracyEl.textContent = '100%';
        progressEl.style.width = '0%';
        bestWpmEl.textContent = bestWpm;
        
        // Setup
        renderText();
        updateCaret();
        hiddenInput.value = "";
        hiddenInput.disabled = false;
        updateChart();
        moveGhost(0);
        
        // Focus for immediate typing
        setTimeout(() => hiddenInput.focus(), 100);
    }

    // Render text with optimized DOM operations
    function renderText() {
        const quote = sentenceBank[Math.floor(Math.random() * sentenceBank.length)];
        const chars = quote.split('');
        const fragment = document.createDocumentFragment();
        
        chars.forEach(char => {
            const span = document.createElement('span');
            span.className = 'char';
            span.textContent = char;
            fragment.appendChild(span);
        });
        
        textRender.innerHTML = '';
        textRender.appendChild(fragment);
    }

    // Update caret position with requestAnimationFrame for smoothness
    function updateCaret() {
        requestAnimationFrame(() => {
            const chars = textRender.querySelectorAll('.char');
            if (chars[charIndex]) {
                const rect = chars[charIndex].getBoundingClientRect();
                const parentRect = textRender.getBoundingClientRect();
                caret.style.left = (rect.left - parentRect.left) + 'px';
                caret.style.top = (rect.top - parentRect.top) + 'px';
            }
        });
    }

    // Move ghost caret based on PB
    function moveGhost(progress) {
        if (bestWpm === 0) {
            ghostCaret.style.opacity = "0";
            return;
        }
        
        requestAnimationFrame(() => {
            const chars = textRender.querySelectorAll('.char');
            const ghostIndex = Math.min(Math.floor(progress * chars.length), chars.length - 1);
            
            if (chars[ghostIndex]) {
                const rect = chars[ghostIndex].getBoundingClientRect();
                const parentRect = textRender.getBoundingClientRect();
                ghostCaret.style.left = (rect.left - parentRect.left) + 'px';
                ghostCaret.style.top = (rect.top - parentRect.top) + 'px';
                ghostCaret.style.opacity = "1";
            }
        });
    }

    // Focus the hidden input
    function focusInput() { 
        hiddenInput.focus(); 
    }

    // Handle typing input with debounced updates
    hiddenInput.addEventListener('input', (e) => {
        if (!isStarted) {
            isStarted = true;
            startTimer();
        }

        const chars = textRender.querySelectorAll('.char');
        const typed = hiddenInput.value;
        
        if (e.inputType === "deleteContentBackward") {
            if (charIndex > 0) {
                charIndex--;
                totalCharsTyped = Math.max(0, totalCharsTyped - 1);
                chars[charIndex].classList.remove('correct', 'incorrect');
            }
        } else {
            const currentChar = typed[charIndex];
            if (currentChar !== undefined) {
                if (chars[charIndex] && chars[charIndex].textContent === currentChar) {
                    chars[charIndex].classList.add('correct');
                    chars[charIndex].classList.remove('incorrect');
                } else {
                    chars[charIndex].classList.add('incorrect');
                    chars[charIndex].classList.remove('correct');
                    totalMistakes++;
                }
                charIndex++;
                totalCharsTyped++;
            }
        }

        // Infinite typing - load new text when finished
        if (charIndex >= chars.length) {
            renderText();
            charIndex = 0;
            hiddenInput.value = "";
        }

        updateCaret();
        calculateLiveStats();
    });

    // Calculate live statistics
    function calculateLiveStats() {
        const timeElapsed = maxTime - timeLeft;
        if (timeElapsed > 0) {
            // Calculate WPM: (correct chars / 5) / (minutes elapsed)
            const correctChars = Math.max(0, totalCharsTyped - totalMistakes);
            const netWPM = Math.round((correctChars / 5) / (timeElapsed / 60));
            wpmEl.textContent = Math.max(0, netWPM);
            
            // Calculate accuracy
            const accuracy = totalCharsTyped > 0 
                ? Math.round(((totalCharsTyped - totalMistakes) / totalCharsTyped) * 100)
                : 100;
            accuracyEl.textContent = accuracy + '%';
        }
        
        // Update progress bar
        const progressPercent = ((maxTime - timeLeft) / maxTime) * 100;
        progressEl.style.width = Math.min(100, progressPercent) + '%';
        progressEl.parentElement.setAttribute('aria-valuenow', Math.round(progressPercent));
    }

    // Start the timer
    function startTimer() {
        timer = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                const timeElapsed = maxTime - timeLeft;
                const currentWpm = parseInt(wpmEl.textContent) || 0;
                
                // Update chart data
                if (timeElapsed % 2 === 0) { // Update every 2 seconds for performance
                    liveLabels.push(timeElapsed + "s");
                    liveDataPoints.push(currentWpm);
                    
                    // Keep data manageable (last 60 points)
                    if (liveDataPoints.length > 60) {
                        liveDataPoints.shift();
                        liveLabels.shift();
                    }
                    
                    updateChart();
                }
                
                // Move ghost caret
                if (bestWpm > 0) {
                    const pbCharsPerSec = (bestWpm * 5) / 60;
                    const charsInCurrentLine = textRender.querySelectorAll('.char').length;
                    const pbProgressThisLine = (pbCharsPerSec * timeElapsed) % charsInCurrentLine;
                    moveGhost(pbProgressThisLine / charsInCurrentLine);
                }
            } else {
                endTest();
            }
        }, 1000);
    }

    // End the test
    function endTest() {
        clearInterval(timer);
        hiddenInput.disabled = true;
        const finalWpm = parseInt(wpmEl.textContent) || 0;
        
        if (finalWpm > bestWpm) {
            bestWpm = finalWpm;
            localStorage.setItem('pro_best', bestWpm.toString());
            bestWpmEl.textContent = bestWpm;
        }
    }

    // Update the chart with performance optimizations
    function updateChart() {
        if (!window.Chart) return; // Wait for Chart.js to load
        
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        if (chart) {
            // Update existing chart data instead of recreating
            chart.data.labels = liveLabels;
            chart.data.datasets[0].data = liveDataPoints;
            chart.update('none'); // 'none' for no animations, better performance
        } else {
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: liveLabels,
                    datasets: [{
                        label: 'Live WPM',
                        data: liveDataPoints,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    animation: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { 
                                color: 'rgba(255,255,255,0.05)' 
                            }, 
                            ticks: { 
                                color: '#6b7280',
                                callback: function(value) {
                                    return value + ' WPM';
                                }
                            } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#6b7280' } 
                        }
                    }
                }
            });
        }
    }

    // Event Listeners
    document.getElementById('restartBtn').addEventListener('click', init);
    document.getElementById('themeBtn').addEventListener('click', () => {
        document.body.classList.toggle('light');
        // Update chart colors on theme change
        if (chart) {
            chart.update();
        }
    });

    document.getElementById('timeSelect').addEventListener('change', init);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            init();
            e.preventDefault();
        }
        if (e.key === 'Escape') {
            hiddenInput.focus();
        }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
    
    // Handle page visibility for better performance
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && isStarted) {
            clearInterval(timer);
        }
    });
</script>

</body>
</html>
